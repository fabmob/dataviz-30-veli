import pandas as pd
import numpy as np
import datetime
from zoneinfo import ZoneInfo
import os

'''
This file contains methods to process the raw data from various questionnaires sent to users.

Most of the methods are used to clean survey data, fixing typos and inconsistencies.

After cleanup, the survey replies are also matched to GPS trip data generated by the process_gps_data.py script.
    Matching is done by comparing declared licence plate and date of the trip to the extracted trip data.
    A large margin of error is allowed, since trip detection is not perfect, and respondants aren't always accurate in dating their trips.

Sources:
    SURVEY_OUTPUT_CSV_FILE (.env): csv file containing answers to the "Carnet de bord" questionnaire (filled after each trip)

Param:
    df_trips : dataframe containing trip data, with one row per trip. It was generated using the process_gps_data.py script.
        It contains the following columns:
            'UniqueTripID', 'coords', 'TotalDistanceKm', 'StartTime', 'EndTime',
            'LicencePlate', 'Brand', 'Model', 'DurationHour', 'AvgSpeed'

Returns:
    trips_with_carnet_match : df_trips dataframe extended with information extracted from the surveys.
        One row still corresponds to one trip, with the exception of survey results that could not be matched. 
        In that case, the new columns corresponding to survey results are filled, and trip columns are set to None.
        When a match is found, both the trip and the survey columns are filled.
        Columns added to the existing df_trips columns (subset of used columns, the dataframe includes every column from the original survey files):
            'carnetEntryIndex', 'territoire', 'nom', 'prenom', 'plate',
            'vehicule', 'date', 'heure_debut', 'heure_fin', 'duree', 'moment',
            'depart', 'arrivee', 'etape', 'distance', 'passagers', 'motif',
            'point_noir_1', 'point_noir_2', 'difficultes_details', 'bilan',
            'commentaires', 'meteo_ensoleille', 'meteo_nuageux', 'meteo_pluvieux',
            'meteo_venteux', 'meteo_neigeux', 'meteo_brouillard', 'meteo_autre',
            'avantage_aucun', 'avantage_agilite', 'avantage_confort',
            'avantage_observation', 'avantage_fiertÃ©', 'avantage_reactions',
            'avantage_bien_etre', 'avantage_autre', 'difficulte_aucune',
            'difficulte_visibilite', 'difficulte_amenagement',
            'difficulte_stationnement', 'difficulte_vehicule',
            'difficulte_comportement', 'difficulte_autre', 'start_time', 'end_time'
'''

# Support different date and hours formats, creates start_time and end_time columns with datetime objects
def fix_dates(df):
    df["heure_debut"] = df["heure_debut"].apply(lambda x: x if x != "99:99" else "00:00")
    df["heure_fin"] = df["heure_fin"].apply(lambda x: x if ((x != "99:99") & (x != "24:00") & (x != "00:00")) else "23:59")

    # Strip anything after the day info
    def strip_date(x):
        try:
            return x.split(" ")[0]
        except:
            return x
    df["date"] = df["date"].apply(strip_date)

    def compute_datetime(raw_time):
        if "/" in raw_time:
            return datetime.datetime.strptime(raw_time, "%m/%d/%Y %H:%M").replace(tzinfo=ZoneInfo("Europe/Paris"))
        return datetime.datetime.strptime(raw_time, "%Y-%m-%d %H:%M").replace(tzinfo=ZoneInfo("Europe/Paris"))

    df["start_time"] = df.date + ' ' + df.heure_debut
    df["end_time"] = df.date + ' ' + df.heure_fin
    df = df[df.start_time.notnull()]
    df = df[df.end_time.notnull()]
    
    df.start_time = df.start_time.apply(compute_datetime)
    df.end_time = df.end_time.apply(compute_datetime)

    df["date"] = df["start_time"].dt.strftime("%Y-%m-%d")

    return df

def process_carnet(df_trips):
    df_survey = pd.read_csv(os.getenv("SURVEY_OUTPUT_CSV_FILE"), sep=";")

    df_survey = fix_dates(df_survey)

    df_survey["carnetEntryIndex"] = df_survey.index

    # Find matching GPS trips
    one_hour_delta = datetime.timedelta(hours=1)
    def find_carnet_entry_index(trip_row):
        res = df_survey[
            (df_survey.plate == trip_row.LicencePlate) & 
            # Tstart in [Cstart-1:Cend+1] or Tend in [Cstart-1:Cend+1]
            (((trip_row['StartTime'] >= df_survey.start_time - one_hour_delta) & (trip_row["StartTime"] <= df_survey.end_time + one_hour_delta)) |
            ((trip_row['EndTime'] >= df_survey.start_time - one_hour_delta) & (trip_row["EndTime"] <= df_survey.end_time + one_hour_delta)))
        ]
        if res.empty:
            return None
        return res.carnetEntryIndex.iloc[0]
    
    df_trips['carnetEntryIndex'] = pd.Series(dtype='int')
    for index, trip_row in df_trips.iterrows():
        carnetEntryIndex = find_carnet_entry_index(trip_row)
        if carnetEntryIndex is not None:
            df_trips.loc[index, 'carnetEntryIndex'] = carnetEntryIndex

    trips_with_carnet_match = df_trips.merge(df_survey, on="carnetEntryIndex", how="outer")

    return trips_with_carnet_match